<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1f2937">
    <meta name="description" content="Track your workouts and nutrition with ease">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Lift & Fuel Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sticky-tabs {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgb(17, 24, 39);
            border-bottom: 2px solid rgb(55, 65, 81);
        }
        .tab-active {
            border-bottom: 3px solid rgb(59, 130, 246);
            color: rgb(59, 130, 246);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="app"></div>

    <script>
        const storage = {
            get: (key) => {
                const value = localStorage.getItem(key);
                return value ? { value } : null;
            },
            set: (key, value) => {
                localStorage.setItem(key, value);
            }
        };

        const DEFAULT_WORKOUT_PLAN = {
            monday: {
                name: 'Monday - Push',
                exercises: [
                    { name: 'Incline Barbell Bench Press', sets: 4, reps: '6-8' },
                    { name: 'Flat Dumbbell Bench Press', sets: 3, reps: '8-10' },
                    { name: 'Seated DB Shoulder Press', sets: 4, reps: '8-10' },
                    { name: 'Cable or Machine Chest Fly', sets: 3, reps: '12-15' },
                    { name: 'Dumbbell Lateral Raise', sets: 4, reps: '12-15' },
                    { name: 'Tricep Rope Pushdown', sets: 3, reps: '10-12' },
                    { name: 'Overhead DB Tricep Extension', sets: 3, reps: '12-15' },
                    { name: 'Core: Cable Woodchoppers', sets: 3, reps: '12 each' }
                ]
            },
            tuesday: {
                name: 'Tuesday - Pull',
                exercises: [
                    { name: 'Lat Pulldown / Assisted Pull-Up', sets: 4, reps: '8-10' },
                    { name: 'Chest-Supported Seated Row', sets: 4, reps: '8-10' },
                    { name: 'Cable Row (Neutral or Wide)', sets: 3, reps: '10-12' },
                    { name: 'Reverse Fly (Cable or Machine)', sets: 3, reps: '12-15' },
                    { name: 'Incline DB Curls', sets: 3, reps: '10-12' },
                    { name: 'Hammer Curls', sets: 3, reps: '10-12' },
                    { name: 'Back Extensions', sets: 3, reps: '12-15' },
                    { name: 'Core: Hanging Knee Raise', sets: 3, reps: '10-12' }
                ]
            },
            wednesday: {
                name: 'Wednesday - Legs',
                exercises: [
                    { name: 'Hack Squat', sets: 4, reps: '8-10' },
                    { name: 'Leg Press', sets: 4, reps: '12-15' },
                    { name: 'Bulgarian Split Squats', sets: 3, reps: '8-10 each' },
                    { name: 'Leg Extensions', sets: 3, reps: '12-15' },
                    { name: 'Seated Calf Raise', sets: 4, reps: '12-15' },
                    { name: 'Standing Calf Raise', sets: 3, reps: '15-20' },
                    { name: 'Planks', sets: 3, reps: '45-60s' },
                    { name: 'Dead Bugs', sets: 3, reps: '20' }
                ]
            },
            thursday: {
                name: 'Thursday - Shoulders & Arms',
                exercises: [
                    { name: 'DB Shoulder Press', sets: 3, reps: '8-10' },
                    { name: 'Cable Lateral Raise (Single Arm)', sets: 4, reps: '12-15' },
                    { name: 'Rear Delt Cable Fly', sets: 3, reps: '12-15' },
                    { name: 'Barbell or EZ-Bar Curl', sets: 3, reps: '8-10' },
                    { name: 'Concentration Curl', sets: 3, reps: '10-12' },
                    { name: 'Cable Tricep Pushdown', sets: 3, reps: '10-12' },
                    { name: 'Dips (Machine or Bodyweight)', sets: 3, reps: '8-12' },
                    { name: 'Core: Cable Crunch', sets: 3, reps: '12-15' }
                ]
            },
            friday: {
                name: 'Friday - Posterior Chain',
                exercises: [
                    { name: 'DB Romanian Deadlift', sets: 4, reps: '8-10' },
                    { name: 'Seated Row (Close Grip)', sets: 3, reps: '10-12' },
                    { name: 'Wide-Grip Lat Pulldown', sets: 3, reps: '10-12' },
                    { name: 'Straight-Arm Pulldown', sets: 3, reps: '12-15' },
                    { name: 'Glute-Ham Raise or Hamstring Curl', sets: 3, reps: '10-12' },
                    { name: 'Back Extension', sets: 3, reps: '12-15' },
                    { name: 'Calves (Any Machine)', sets: 3, reps: '12-15' },
                    { name: 'Core: Weighted Plank', sets: 3, reps: '30-45s' }
                ]
            },
            saturday: {
                name: 'Saturday - Cardio',
                exercises: [
                    { name: 'Walk 10,000 Steps', sets: 1, reps: '10k steps' }
                ]
            },
            sunday: {
                name: 'Sunday - Cardio',
                exercises: [
                    { name: 'Walk 10,000 Steps', sets: 1, reps: '10k steps' }
                ]
            }
        };

        const DEFAULT_MEAL_PLANS = {
            lowCarb: {
                name: 'Low Carb',
                preMeal: ['¬Ω lime', '1 tsp EAA in water', '1 tbsp ACV in water', '10 oz water', 'Probiotic ‚Äì 2 caps', 'Sauerkraut ‚Äì 2 tbsp', 'Garlic pill ‚Äì 1'],
                postMeal: ['Omega-3: 2 softgels', 'Vitamin D3: 1 softgel (2000 IU)', 'Glutathione: 1 cap (500mg)'],
                meals: [
                    { name: 'Meal 1', items: ['Egg whites: 10 oz', 'Chicken breast: 6 oz', 'Cheddar: 1.5 oz', 'Cucumber: ¬Ω + lime'] },
                    { name: 'Meal 2', items: ['4 whole eggs (280¬∞F - 13 min)', '2 egg-white wraps', 'Sauerkraut: 2 tbsp', 'Avocado: ¬Ω'] },
                    { name: 'Meal 3', items: ['Ground beef (90/10): 6 oz', 'Chicken breast: 6 oz', 'Cauliflower rice: 1.5 cups', 'Lettuce: 1 handful', 'Avocado: ¬Ω', 'Sauerkraut: 2 tbsp', 'Omega-3: 1 softgel'] },
                    { name: 'Meal 4', items: ['Greek yogurt (2%): 8 oz', 'Cottage cheese: ¬Ω cup', 'Protein isolate: ¬Ω scoop', 'Cashews: 20', 'Egg-white wraps: 2', 'Cinnamon'] },
                    { name: 'Meal 5', items: ['Egg whites: 10 oz', 'Chicken breast: 6 oz', 'Cheddar: 1 slice', 'Cucumber: ¬Ω'] }
                ],
                beforeBed: ['Magnesium glycinate: 400 mg', 'Black seed oil: 1 capsule', 'L-theanine: 200 mg', 'Lime + EAA + ACV drink']
            },
            moderateCarb: {
                name: 'Moderate Carb',
                preMeal: ['¬Ω lime', '1 tsp EAA in water', '1 tbsp ACV in water', '10 oz water', 'Probiotic ‚Äì 2 caps', 'Sauerkraut ‚Äì 2 tbsp', 'Garlic pill ‚Äì 1'],
                postMeal: ['Omega-3: 2 softgels', 'Vitamin D3: 1 softgel (2000 IU)', 'Glutathione: 1 cap (500mg)'],
                meals: [
                    { name: 'Meal 1', items: ['Egg whites: 10 oz', 'Chicken breast: 4 oz', 'Cheddar: 1 slice', 'Cucumber: ¬Ω'] },
                    { name: 'Meal 2', items: ['3 whole eggs (280¬∞F - 13 min)', 'Sweet potato: 6 oz (390¬∞F - 40 min)', '2 rice cakes', 'Sauerkraut: 2 tbsp', 'Avocado: ¬Ω'] },
                    { name: 'Meal 3', items: ['Oats: 50g dry', 'Whey isolate: 1 scoop', 'Blueberries: ¬Ω cup', 'Cashews: 15', 'Chicken breast: 6 oz', 'Cinnamon'] },
                    { name: 'Meal 4', items: ['Greek yogurt (2%): 8 oz', 'Cottage cheese: ¬Ω cup', 'Protein isolate: ¬Ω scoop', 'Cashews: 20', 'Egg-white wraps: 2', 'Cinnamon', '¬Ω banana OR ¬Ω cup berries'] },
                    { name: 'Meal 5', items: ['Egg whites: 10 oz', 'Chicken breast: 4 oz', 'Cheddar: 1 slice', 'Cucumber: ¬Ω'] }
                ],
                beforeBed: ['Magnesium glycinate: 400 mg', 'Black seed oil: 1 capsule', 'L-theanine: 200 mg', 'Lime + EAA + ACV drink']
            }
        };

        const DAY_MEAL_MAP = {
            monday: 'lowCarb',
            tuesday: 'lowCarb',
            wednesday: 'moderateCarb',
            thursday: 'lowCarb',
            friday: 'moderateCarb',
            saturday: 'lowCarb',
            sunday: 'lowCarb'
        };

        let state = {
            view: 'loading',
            currentProfile: '',
            programName: 'My Workout Plan',
            selectedDay: 'monday',
            currentWeek: 1,
            actualCurrentWeek: 1,
            activeTab: 'workout',
            workoutData: {},
            workoutPlan: JSON.parse(JSON.stringify(DEFAULT_WORKOUT_PLAN)),
            mealPlans: JSON.parse(JSON.stringify(DEFAULT_MEAL_PLANS)),
            dayMealMap: {...DAY_MEAL_MAP},
            expandedExercise: null,
            editWorkout: false,
            editMeals: false,
            showSettings: false,
            mealReminders: {
                enabled: false,
                times: {
                    meal1: '07:00',
                    meal2: '10:00',
                    meal3: '13:00',
                    meal4: '16:00',
                    meal5: '19:00'
                }
            }
        };

        function init() {
            const profile = storage.get('current-profile');
            if (!profile || !profile.value) {
                state.view = 'welcome';
                render();
                return;
            }
            state.currentProfile = profile.value;
            loadProfile(profile.value);
            state.view = 'main';
            render();
        }

        function createProfile() {
            const nameInput = document.getElementById('profile-name-input');
            const programInput = document.getElementById('program-name-input');
            if (!nameInput || !nameInput.value.trim()) return;
            
            storage.set('current-profile', nameInput.value);
            state.currentProfile = nameInput.value;
            state.programName = programInput.value.trim() || 'My Workout Plan';
            
            saveProfile();
            state.view = 'main';
            render();
        }

        function loadProfile(name) {
            const data = storage.get(`${name}-data`);
            const plan = storage.get(`${name}-plan`);
            const meals = storage.get(`${name}-meals`);
            const currentWeek = storage.get(`${name}-currentWeek`);
            const actualWeek = storage.get(`${name}-actualWeek`);
            const programName = storage.get(`${name}-programName`);
            const dayMealMap = storage.get(`${name}-dayMealMap`);
            const reminders = storage.get(`${name}-reminders`);
            
            // Load the week you were viewing
            if (currentWeek && currentWeek.value) {
                state.currentWeek = parseInt(currentWeek.value);
            }
            
            // Load the latest week you've reached
            if (actualWeek && actualWeek.value) {
                state.actualCurrentWeek = parseInt(actualWeek.value);
            }
            
            // Fallback to old storage key for backwards compatibility
            if (!currentWeek && !actualWeek) {
                const oldWeek = storage.get(`${name}-week`);
                if (oldWeek && oldWeek.value) {
                    const w = parseInt(oldWeek.value);
                    state.currentWeek = w;
                    state.actualCurrentWeek = w;
                }
            }
            
            state.workoutData = data && data.value ? JSON.parse(data.value) : {};
            state.workoutPlan = plan && plan.value ? JSON.parse(plan.value) : JSON.parse(JSON.stringify(DEFAULT_WORKOUT_PLAN));
            state.mealPlans = meals && meals.value ? JSON.parse(meals.value) : JSON.parse(JSON.stringify(DEFAULT_MEAL_PLANS));
            state.programName = programName && programName.value ? programName.value : 'My Workout Plan';
            state.dayMealMap = dayMealMap && dayMealMap.value ? JSON.parse(dayMealMap.value) : {...DAY_MEAL_MAP};
            state.mealReminders = reminders && reminders.value ? JSON.parse(reminders.value) : state.mealReminders;
            
            // Migration: Convert old day names to new format
            migrateOldDayNames();
            
            // Ensure all 7 days exist (in case user has old data)
            ensureAllDaysExist();
            
            // Schedule reminders if enabled
            if (state.mealReminders.enabled) {
                scheduleAllReminders();
            }
        }

        function ensureAllDaysExist() {
            const requiredDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            let needsSave = false;
            
            for (let day of requiredDays) {
                if (!state.workoutPlan[day]) {
                    state.workoutPlan[day] = JSON.parse(JSON.stringify(DEFAULT_WORKOUT_PLAN[day]));
                    needsSave = true;
                }
                if (!state.dayMealMap[day]) {
                    state.dayMealMap[day] = DAY_MEAL_MAP[day];
                    needsSave = true;
                }
            }
            
            if (needsSave) {
                saveProfile();
            }
        }

        function migrateOldDayNames() {
            const oldToNew = {
                'push': 'monday',
                'pull': 'tuesday',
                'legs': 'wednesday',
                'shoulders': 'thursday',
                'posterior': 'friday',
                'day6': 'saturday',
                'day7': 'sunday'
            };
            
            // Migrate workout plan
            let needsSave = false;
            for (let oldDay in oldToNew) {
                if (state.workoutPlan[oldDay]) {
                    state.workoutPlan[oldToNew[oldDay]] = state.workoutPlan[oldDay];
                    delete state.workoutPlan[oldDay];
                    needsSave = true;
                }
            }
            
            // Fix day names in workout plan (convert "Day 1 - Push" to "Monday - Push")
            const nameMapping = {
                'Day 1': 'Monday',
                'Day 2': 'Tuesday',
                'Day 3': 'Wednesday',
                'Day 4': 'Thursday',
                'Day 5': 'Friday',
                'Day 6': 'Saturday',
                'Day 7': 'Sunday'
            };
            
            for (let day in state.workoutPlan) {
                let name = state.workoutPlan[day].name;
                for (let oldName in nameMapping) {
                    if (name.includes(oldName)) {
                        state.workoutPlan[day].name = name.replace(oldName, nameMapping[oldName]);
                        needsSave = true;
                    }
                }
            }
            
            // Migrate workout data (weights/reps)
            const newWorkoutData = {};
            for (let key in state.workoutData) {
                let newKey = key;
                for (let oldDay in oldToNew) {
                    if (key.includes(`-${oldDay}-`)) {
                        newKey = key.replace(`-${oldDay}-`, `-${oldToNew[oldDay]}-`);
                        needsSave = true;
                        break;
                    }
                }
                newWorkoutData[newKey] = state.workoutData[key];
            }
            state.workoutData = newWorkoutData;
            
            // Migrate day meal map
            for (let oldDay in oldToNew) {
                if (state.dayMealMap[oldDay]) {
                    state.dayMealMap[oldToNew[oldDay]] = state.dayMealMap[oldDay];
                    delete state.dayMealMap[oldDay];
                    needsSave = true;
                }
            }
            
            if (needsSave) {
                saveProfile();
            }
        }

        function saveProfile() {
            if (!state.currentProfile) return;
            storage.set(`${state.currentProfile}-currentWeek`, state.currentWeek.toString());
            storage.set(`${state.currentProfile}-actualWeek`, state.actualCurrentWeek.toString());
            storage.set(`${state.currentProfile}-data`, JSON.stringify(state.workoutData));
            storage.set(`${state.currentProfile}-plan`, JSON.stringify(state.workoutPlan));
            storage.set(`${state.currentProfile}-meals`, JSON.stringify(state.mealPlans));
            storage.set(`${state.currentProfile}-programName`, state.programName);
            storage.set(`${state.currentProfile}-dayMealMap`, JSON.stringify(state.dayMealMap));
            storage.set(`${state.currentProfile}-reminders`, JSON.stringify(state.mealReminders));
            
            // Show save indicator
            showSaveIndicator();
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('autosave-indicator');
            if (indicator) {
                indicator.style.opacity = '1';
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 2000); // Show for 2 seconds
            }
        }

        function changeProfile() {
            const newName = prompt('Enter your profile name:');
            if (!newName || !newName.trim()) return;
            storage.set('current-profile', newName);
            state.currentProfile = newName;
            loadProfile(newName);
            render();
        }

        function updateWeight(exerciseName, setIndex, weight) {
            const key = `week${state.currentWeek}-${state.selectedDay}-${exerciseName}-set${setIndex}`;
            state.workoutData[key] = weight;
        }

        function updateReps(exerciseName, setIndex, reps) {
            const key = `week${state.currentWeek}-${state.selectedDay}-${exerciseName}-set${setIndex}-reps`;
            state.workoutData[key] = reps;
        }

        function getWeight(exerciseName, setIndex, week = state.currentWeek) {
            const key = `week${week}-${state.selectedDay}-${exerciseName}-set${setIndex}`;
            return state.workoutData[key] || '';
        }

        function getReps(exerciseName, setIndex, week = state.currentWeek) {
            const key = `week${week}-${state.selectedDay}-${exerciseName}-set${setIndex}-reps`;
            return state.workoutData[key] || '';
        }

        function nextWeek() {
            const newWeek = state.currentWeek + 1;
            state.currentWeek = newWeek;
            if (newWeek > state.actualCurrentWeek) {
                state.actualCurrentWeek = newWeek;
            }
            saveProfile();
            render();
        }

        function previousWeek() {
            if (state.currentWeek > 1) {
                state.currentWeek--;
                render();
            }
        }

        function exportData() {
            if (!state.currentProfile) return;
            let csv = 'Week,Day,Exercise,Set,Weight,Reps\n';
            const entries = {};
            
            for (let key in state.workoutData) {
                const match = key.match(/week(\d+)-(\w+)-(.+)-set(\d+)(-reps)?$/);
                if (match) {
                    const [_, week, day, exercise, set, isReps] = match;
                    const entryKey = `${week}-${day}-${exercise}-${set}`;
                    if (!entries[entryKey]) {
                        entries[entryKey] = { week, day, exercise, set: parseInt(set) + 1, weight: '', reps: '' };
                    }
                    if (isReps === '-reps') {
                        entries[entryKey].reps = state.workoutData[key];
                    } else {
                        entries[entryKey].weight = state.workoutData[key];
                    }
                }
            }
            
            for (let key in entries) {
                const e = entries[key];
                csv += `${e.week},${e.day},${e.exercise},${e.set},${e.weight},${e.reps}\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.currentProfile}-workout-data.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function addExercise() {
            const name = document.getElementById('new-exercise-name').value;
            const sets = parseInt(document.getElementById('new-exercise-sets').value);
            const reps = document.getElementById('new-exercise-reps').value;
            if (!name.trim()) return;
            
            state.workoutPlan[state.selectedDay].exercises.push({ name, sets, reps });
            state.view = 'main';
            saveProfile();
            render();
        }

        function deleteExercise(idx) {
            if (!confirm('Delete this exercise?')) return;
            state.workoutPlan[state.selectedDay].exercises.splice(idx, 1);
            saveProfile();
            render();
        }

        function updateExercise(idx, field, value) {
            state.workoutPlan[state.selectedDay].exercises[idx][field] = value;
        }

        function addMealItem(mealPlan, section, sectionIdx) {
            const item = prompt('Enter new item:');
            if (!item || !item.trim()) return;
            
            if (section === 'meal') {
                state.mealPlans[mealPlan].meals[sectionIdx].items.push(item);
            } else if (section === 'preMeal') {
                state.mealPlans[mealPlan].preMeal.push(item);
            } else if (section === 'postMeal') {
                state.mealPlans[mealPlan].postMeal.push(item);
            } else if (section === 'beforeBed') {
                state.mealPlans[mealPlan].beforeBed.push(item);
            }
            saveProfile();
            render();
        }

        function deleteMealItem(mealPlan, section, sectionIdx, itemIdx) {
            if (!confirm('Delete this item?')) return;
            
            if (section === 'meal') {
                state.mealPlans[mealPlan].meals[sectionIdx].items.splice(itemIdx, 1);
            } else if (section === 'preMeal') {
                state.mealPlans[mealPlan].preMeal.splice(itemIdx, 1);
            } else if (section === 'postMeal') {
                state.mealPlans[mealPlan].postMeal.splice(itemIdx, 1);
            } else if (section === 'beforeBed') {
                state.mealPlans[mealPlan].beforeBed.splice(itemIdx, 1);
            }
            saveProfile();
            render();
        }

        function updateProgramName() {
            const newName = prompt('Program name:', state.programName);
            if (newName && newName.trim()) {
                state.programName = newName.trim();
                saveProfile();
                render();
            }
        }

        // Meal Reminder Functions
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('Your browser does not support notifications');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        state.mealReminders.enabled = true;
                        scheduleAllReminders();
                        saveProfile();
                        render();
                    }
                });
            }
            return false;
        }

        function toggleMealReminders() {
            if (!state.mealReminders.enabled) {
                // Turning ON
                if (Notification.permission === 'granted') {
                    state.mealReminders.enabled = true;
                    scheduleAllReminders();
                    saveProfile();
                    render();
                } else {
                    requestNotificationPermission();
                }
            } else {
                // Turning OFF
                state.mealReminders.enabled = false;
                cancelAllReminders();
                saveProfile();
                render();
            }
        }

        let reminderIntervals = {};

        function scheduleAllReminders() {
            cancelAllReminders();
            
            if (!state.mealReminders.enabled) return;
            
            for (let meal in state.mealReminders.times) {
                scheduleMealReminder(meal, state.mealReminders.times[meal]);
            }
        }

        function scheduleMealReminder(meal, time) {
            const [hours, minutes] = time.split(':').map(Number);
            
            function checkAndNotify() {
                const now = new Date();
                if (now.getHours() === hours && now.getMinutes() === minutes) {
                    showMealNotification(meal);
                }
            }
            
            // Check every minute
            reminderIntervals[meal] = setInterval(checkAndNotify, 60000);
            // Check immediately in case we're at the right time
            checkAndNotify();
        }

        function cancelAllReminders() {
            for (let meal in reminderIntervals) {
                clearInterval(reminderIntervals[meal]);
            }
            reminderIntervals = {};
        }

        function showMealNotification(meal) {
            if (!state.mealReminders.enabled || Notification.permission !== 'granted') return;
            
            const mealNames = {
                meal1: 'Meal 1',
                meal2: 'Meal 2',
                meal3: 'Meal 3',
                meal4: 'Meal 4',
                meal5: 'Meal 5'
            };
            
            new Notification('üçΩÔ∏è Time to Eat!', {
                body: `${mealNames[meal]} - Tap to open tracker`,
                icon: 'icon-192.png',
                badge: 'icon-192.png',
                tag: meal,
                requireInteraction: false
            });
        }

        function updateMealTime(meal, time) {
            state.mealReminders.times[meal] = time;
            saveProfile();
            if (state.mealReminders.enabled) {
                scheduleAllReminders();
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.view === 'loading') {
                app.innerHTML = '<div class="flex items-center justify-center h-screen"><div class="text-xl">Loading...</div></div>';
                return;
            }
            
            if (state.view === 'welcome') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full">
                            <h1 class="text-3xl font-bold mb-2">üí™ Lift & Fuel</h1>
                            <p class="text-gray-400 mb-6">Track workouts and nutrition</p>
                            <input id="profile-name-input" type="text" class="w-full px-3 py-2 mb-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Your name" onkeypress="if(event.key==='Enter') document.getElementById('program-name-input').focus()">
                            <input id="program-name-input" type="text" class="w-full px-3 py-2 mb-4 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Program name (optional)" value="My Workout Plan" onkeypress="if(event.key==='Enter') createProfile()">
                            <button onclick="createProfile()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold">Start Tracking</button>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.view === 'add-exercise') {
                app.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">Add Exercise</h3>
                                <button onclick="state.view='main'; render();" class="text-gray-400 hover:text-white">‚úï</button>
                            </div>
                            <input id="new-exercise-name" type="text" class="w-full px-3 py-2 mb-3 bg-gray-700 rounded border border-gray-600" placeholder="Exercise name">
                            <input id="new-exercise-sets" type="number" value="3" class="w-full px-3 py-2 mb-3 bg-gray-700 rounded border border-gray-600" placeholder="Sets">
                            <input id="new-exercise-reps" type="text" value="8-12" class="w-full px-3 py-2 mb-4 bg-gray-700 rounded border border-gray-600" placeholder="Rep range">
                            <button onclick="addExercise()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">Add</button>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.showSettings) {
                app.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full my-8">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold">Settings</h3>
                                <button onclick="state.showSettings=false; render();" class="text-gray-400 hover:text-white">‚úï</button>
                            </div>
                            
                            <div class="space-y-3 mb-6">
                                <button onclick="updateProgramName()" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded text-left">
                                    ‚úèÔ∏è Edit Program Name<br><span class="text-sm text-gray-400">${state.programName}</span>
                                </button>
                                <button onclick="changeProfile()" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded text-left">
                                    üë§ Switch Profile<br><span class="text-sm text-gray-400">${state.currentProfile}</span>
                                </button>
                                <button onclick="exportData()" class="w-full px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded text-left">
                                    üìä Export Data
                                </button>
                            </div>

                            <div class="border-t border-gray-700 pt-4">
                                <h4 class="font-semibold mb-3 flex items-center justify-between">
                                    <span>üîî Meal Reminders</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${state.mealReminders.enabled ? 'checked' : ''} onchange="toggleMealReminders()" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </h4>
                                
                                ${state.mealReminders.enabled ? `
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-300">Meal 1:</span>
                                            <input type="time" value="${state.mealReminders.times.meal1}" onchange="updateMealTime('meal1', this.value)" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-300">Meal 2:</span>
                                            <input type="time" value="${state.mealReminders.times.meal2}" onchange="updateMealTime('meal2', this.value)" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-300">Meal 3:</span>
                                            <input type="time" value="${state.mealReminders.times.meal3}" onchange="updateMealTime('meal3', this.value)" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-300">Meal 4:</span>
                                            <input type="time" value="${state.mealReminders.times.meal4}" onchange="updateMealTime('meal4', this.value)" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">
                                        </div>
                                        <div class="flex items-center justify-between py-2">
                                            <span class="text-gray-300">Meal 5:</span>
                                            <input type="time" value="${state.mealReminders.times.meal5}" onchange="updateMealTime('meal5', this.value)" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">
                                        </div>
                                        <p class="text-xs text-gray-500 mt-3">üí° Notifications work best when app is installed on home screen</p>
                                    </div>
                                ` : `
                                    <p class="text-sm text-gray-400">Enable reminders to get notified when it's time to eat</p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Main view
            // Safety check: if selectedDay doesn't exist, default to monday
            if (!state.workoutPlan[state.selectedDay]) {
                state.selectedDay = 'monday';
            }
            
            const exercises = state.workoutPlan[state.selectedDay].exercises;
            const currentMealPlan = state.mealPlans[state.dayMealMap[state.selectedDay]];
            
            // Force correct day order
            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayButtons = dayOrder.map(day => {
                if (!state.workoutPlan[day]) return '';
                
                const carbType = state.dayMealMap[day];
                const carbIcon = carbType === 'moderateCarb' ? 'üü†' : 'üü¢';
                
                // Ultra short names for compact display
                const shortName = state.workoutPlan[day].name.split(' - ')[0]
                    .replace('Monday', 'Mon')
                    .replace('Tuesday', 'Tue')
                    .replace('Wednesday', 'Wed')
                    .replace('Thursday', 'Thu')
                    .replace('Friday', 'Fri')
                    .replace('Saturday', 'Sat')
                    .replace('Sunday', 'Sun');
                
                return `
                    <button onclick="state.selectedDay='${day}'; saveProfile(); render();" class="flex-1 py-3 px-1 rounded flex flex-col items-center justify-center gap-1 text-xs ${state.selectedDay === day ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'}">
                        <span class="font-semibold">${shortName}</span>
                        <span>${carbIcon}</span>
                    </button>
                `;
            }).join('');

            let workoutContent = '';
            const exerciseList = exercises.map((ex, idx) => {
                    const expanded = state.expandedExercise === idx;
                    let setsHtml = '';
                    
                    if (expanded && !state.editWorkout) {
                        const currentSets = Array.from({length: ex.sets}, (_, s) => `
                            <div>
                                <label class="text-xs text-gray-400 block mb-1">Set ${s + 1}</label>
                                <div class="space-y-1">
                                    <input type="number" value="${getWeight(ex.name, s)}" 
                                        onchange="updateWeight('${ex.name}', ${s}, this.value); saveProfile();"
                                        class="w-full px-2 py-2 bg-gray-700 rounded border border-gray-600 text-sm" placeholder="lbs">
                                    <input type="number" value="${getReps(ex.name, s)}" 
                                        onchange="updateReps('${ex.name}', ${s}, this.value); saveProfile();"
                                        class="w-full px-2 py-2 bg-gray-700 rounded border border-gray-600 text-sm" placeholder="reps">
                                </div>
                            </div>
                        `).join('');
                        
                        let lastWeekHtml = '';
                        if (state.currentWeek > 1) {
                            const lastSets = Array.from({length: ex.sets}, (_, s) => {
                                const lastWeight = getWeight(ex.name, s, state.currentWeek - 1);
                                const lastReps = getReps(ex.name, s, state.currentWeek - 1);
                                return `
                                    <div>
                                        <label class="text-xs text-gray-400 block mb-1">Set ${s + 1}</label>
                                        <div class="space-y-1">
                                            <div class="w-full px-2 py-2 bg-gray-800 rounded border border-gray-700 text-center text-sm">${lastWeight || '-'}</div>
                                            <div class="w-full px-2 py-2 bg-gray-800 rounded border border-gray-700 text-center text-sm text-green-300">${lastReps || '-'}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            
                            lastWeekHtml = `
                                <div class="pt-3 border-t border-gray-700">
                                    <p class="text-sm font-semibold mb-2 text-gray-400">Week ${state.currentWeek - 1} (Last Week)</p>
                                    <div class="grid grid-cols-4 gap-2">${lastSets}</div>
                                </div>
                            `;
                        }
                        
                        setsHtml = `
                            <div class="p-4 pt-0 space-y-3">
                                <div>
                                    <p class="text-sm font-semibold mb-2 text-blue-400">Week ${state.currentWeek}</p>
                                    <div class="grid grid-cols-4 gap-2">${currentSets}</div>
                                </div>
                                ${lastWeekHtml}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="bg-gray-800 rounded-lg overflow-hidden">
                            <div class="flex items-center justify-between p-4">
                                <button onclick="state.expandedExercise = state.expandedExercise === ${idx} ? null : ${idx}; saveProfile(); render();" class="flex-1 flex items-center justify-between text-left">
                                    <div class="flex-1">
                                        ${state.editWorkout ? `
                                            <input type="text" value="${ex.name}" onchange="updateExercise(${idx}, 'name', this.value); saveProfile();" onclick="event.stopPropagation();" class="bg-gray-700 px-2 py-1 rounded text-lg font-semibold mb-1 w-full">
                                            <div class="flex gap-2 items-center" onclick="event.stopPropagation();">
                                                <input type="number" value="${ex.sets}" onchange="updateExercise(${idx}, 'sets', parseInt(this.value)); saveProfile();" class="bg-gray-700 px-2 py-1 rounded w-16 text-sm">
                                                <span class="text-sm text-gray-400">√ó</span>
                                                <input type="text" value="${ex.reps}" onchange="updateExercise(${idx}, 'reps', this.value); saveProfile();" class="bg-gray-700 px-2 py-1 rounded w-20 text-sm">
                                            </div>
                                        ` : `
                                            <h3 class="font-semibold text-lg">${ex.name}</h3>
                                            <p class="text-sm text-gray-400">${ex.sets} sets √ó ${ex.reps} reps</p>
                                        `}
                                    </div>
                                    ${!state.editWorkout ? `<span>${expanded ? '‚ñ≤' : '‚ñº'}</span>` : ''}
                                </button>
                                ${state.editWorkout ? `
                                    <button onclick="deleteExercise(${idx})" class="ml-2 p-2 bg-red-600 hover:bg-red-700 rounded">üóë</button>
                                ` : ''}
                            </div>
                            ${setsHtml}
                        </div>
                    `;
                }).join('');

            workoutContent = `
                <div class="mb-4 flex items-center gap-3">
                    <button onclick="state.editWorkout = !state.editWorkout; saveProfile(); render();" class="px-4 py-2 rounded ${state.editWorkout ? 'bg-orange-600' : 'bg-gray-700'} hover:opacity-90">
                        ${state.editWorkout ? '‚úì Done' : '‚úèÔ∏è Edit'}
                    </button>
                    ${state.editWorkout ? `<button onclick="state.view='add-exercise'; saveProfile(); render();" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">‚ûï Add</button>` : ''}
                </div>
                <div class="space-y-4">${exerciseList}</div>
            `;

            let mealsContent = `
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-green-400">${state.workoutPlan[state.selectedDay].name.split(' - ')[0]}'s Meals</h2>
                    <p class="text-sm text-gray-400">${currentMealPlan.name} Plan</p>
                </div>
                <div class="flex items-center justify-end mb-4">
                    <button onclick="state.editMeals = !state.editMeals; saveProfile(); render();" class="px-4 py-2 rounded ${state.editMeals ? 'bg-orange-600' : 'bg-gray-700'} hover:opacity-90 text-sm">
                        ${state.editMeals ? '‚úì Done' : '‚úèÔ∏è Edit'}
                    </button>
                </div>
                
                <div class="mb-6 bg-gray-800 p-4 rounded">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-blue-400">PRE-MEAL 1</h3>
                        ${state.editMeals ? `<button onclick="addMealItem('${state.dayMealMap[state.selectedDay]}', 'preMeal')" class="text-green-400 text-sm">+ Add</button>` : ''}
                    </div>
                    <ul class="space-y-2">
                        ${currentMealPlan.preMeal.map((item, i) => `
                            <li class="flex items-center justify-between text-gray-300">
                                <span>‚Ä¢ ${item}</span>
                                ${state.editMeals ? `<button onclick="deleteMealItem('${state.dayMealMap[state.selectedDay]}', 'preMeal', null, ${i})" class="text-red-400 text-sm">‚úï</button>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="mb-6 bg-gray-800 p-4 rounded">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-purple-400">POST-MEAL 1 Supplements</h3>
                        ${state.editMeals ? `<button onclick="addMealItem('${state.dayMealMap[state.selectedDay]}', 'postMeal')" class="text-green-400 text-sm">+ Add</button>` : ''}
                    </div>
                    <ul class="space-y-2">
                        ${currentMealPlan.postMeal.map((item, i) => `
                            <li class="flex items-center justify-between text-gray-300">
                                <span>‚Ä¢ ${item}</span>
                                ${state.editMeals ? `<button onclick="deleteMealItem('${state.dayMealMap[state.selectedDay]}', 'postMeal', null, ${i})" class="text-red-400 text-sm">‚úï</button>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>

                ${currentMealPlan.meals.map((meal, mealIdx) => `
                    <div class="mb-6 bg-gray-800 p-4 rounded">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-yellow-400">${meal.name.toUpperCase()}</h3>
                            ${state.editMeals ? `<button onclick="addMealItem('${state.dayMealMap[state.selectedDay]}', 'meal', ${mealIdx})" class="text-green-400 text-sm">+ Add</button>` : ''}
                        </div>
                        <ul class="space-y-2">
                            ${meal.items.map((item, itemIdx) => `
                                <li class="flex items-center justify-between text-gray-300">
                                    <span>‚Ä¢ ${item}</span>
                                    ${state.editMeals ? `<button onclick="deleteMealItem('${state.dayMealMap[state.selectedDay]}', 'meal', ${mealIdx}, ${itemIdx})" class="text-red-400 text-sm">‚úï</button>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('')}

                <div class="bg-gray-800 p-4 rounded">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-indigo-400">BEFORE BED</h3>
                        ${state.editMeals ? `<button onclick="addMealItem('${state.dayMealMap[state.selectedDay]}', 'beforeBed')" class="text-green-400 text-sm">+ Add</button>` : ''}
                    </div>
                    <ul class="space-y-2">
                        ${currentMealPlan.beforeBed.map((item, i) => `
                            <li class="flex items-center justify-between text-gray-300">
                                <span>‚Ä¢ ${item}</span>
                                ${state.editMeals ? `<button onclick="deleteMealItem('${state.dayMealMap[state.selectedDay]}', 'beforeBed', null, ${i})" class="text-red-400 text-sm">‚úï</button>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
            app.innerHTML = `
                <div class="min-h-screen pb-20">
                    <!-- Header -->
                    <div class="bg-gray-800 p-4 border-b border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <h1 class="text-2xl font-bold">üí™ Lift & Fuel</h1>
                                <p class="text-sm text-gray-400">${state.programName}</p>
                            </div>
                            <button onclick="state.showSettings=true; render();" class="p-2 bg-gray-700 hover:bg-gray-600 rounded">‚öôÔ∏è</button>
                        </div>
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="text-lg">üìÖ Week ${state.currentWeek}</span>
                            <button onclick="previousWeek()" ${state.currentWeek === 1 ? 'disabled' : ''} class="px-3 py-1 rounded text-sm ${state.currentWeek === 1 ? 'bg-gray-700 text-gray-500' : 'bg-purple-600 hover:bg-purple-700'}">‚óÄ</button>
                            <button onclick="nextWeek()" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">‚ñ∂</button>
                            <span id="autosave-indicator" class="text-xs text-green-400 opacity-0 transition-opacity duration-300">‚úì Saved</span>
                        </div>
                    </div>

                    <!-- Sticky Tabs -->
                    <div class="sticky-tabs">
                        <div class="flex">
                            <button onclick="state.activeTab='workout'; saveProfile(); render();" class="flex-1 py-4 text-center font-semibold ${state.activeTab === 'workout' ? 'tab-active' : 'text-gray-400'}">
                                üí™ Workout
                            </button>
                            <button onclick="state.activeTab='meals'; saveProfile(); render();" class="flex-1 py-4 text-center font-semibold ${state.activeTab === 'meals' ? 'tab-active' : 'text-gray-400'}">
                                üçΩÔ∏è Meals
                            </button>
                        </div>
                    </div>

                    <!-- Day Selector -->
                    <div class="p-2 bg-gray-800 border-b border-gray-700">
                        <div class="flex gap-1">${dayButtons}</div>
                    </div>

                    <!-- Content -->
                    <div class="p-4">
                        ${state.activeTab === 'workout' ? workoutContent : mealsContent}
                    </div>

                    <!-- Tips -->
                    <div class="p-4 mx-4 mb-4 bg-gray-800 rounded-lg">
                        <h3 class="font-semibold mb-2">üí° Tips</h3>
                        <ul class="text-sm text-gray-400 space-y-1">
                            <li>‚Ä¢ Progressive overload: Add weight or reps each week</li>
                            <li>‚Ä¢ Save after workouts to track your progress</li>
                            <li>‚Ä¢ 2 min rest between sets for hypertrophy</li>
                            <li>‚Ä¢ Customize everything in edit mode</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        init();

        // Auto-save every 30 seconds as backup
        setInterval(() => {
            if (state.currentProfile && state.view === 'main') {
                saveProfile();
                console.log('Auto-saved at', new Date().toLocaleTimeString());
            }
        }, 30000);

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>